<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tailor Board — Restich</title>
  <style>
    :root{
      --bg:#0b0f14; --panel:#101720; --muted:#1f2a37; --soft:#0e141b; --text:#e8eef6; --sub:#b6c2d1; --accent:#7dd3fc; --ok:#34d399; --warn:#fbbf24; --bad:#fb7185; --ready:#60a5fa;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0a1118);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:rgba(10,15,20,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--muted)}
    .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
    h1{margin:0;font-size:20px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,select,button{border-radius:10px;border:1px solid var(--muted);background:var(--soft);color:var(--text);padding:8px 10px;font-size:14px}
    button{cursor:pointer}
    button.primary{background:var(--accent);border:0;color:#06202b;font-weight:700}
    main{padding:18px 0}
    .board{display:grid;grid-template-columns:repeat(4,minmax(260px,1fr));gap:12px;align-items:start}
    .col{background:var(--panel);border:1px solid var(--muted);border-radius:14px;min-height:320px;display:flex;flex-direction:column}
    .col h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--muted);font-size:14px;letter-spacing:.3px}
    .count{opacity:.7;font-weight:400}
    .lane{padding:12px;display:grid;gap:10px;min-height:220px}
    .card{background:#0c131b;border:1px solid var(--muted);border-radius:12px;padding:10px;display:grid;gap:6px}
    .title{display:flex;align-items:center;gap:8px}
    .tag{font-size:11px;border:1px solid var(--muted);border-radius:999px;padding:2px 8px;opacity:.9}
    .prio-Hot{background:#3b0b0b;color:#fecaca;border-color:#7f1d1d}
    .prio-High{background:#3b2906;color:#fde68a;border-color:#7c5f05}
    .prio-Normal{background:#0a2a1b;color:#bbf7d0;border-color:#14532d}
    .deadline{font-size:12px;opacity:.85}
    .meta{display:flex;flex-wrap:wrap;gap:6px;font-size:12px;opacity:.9}
    .small{font-size:12px;opacity:.8}
    .ghost{background:transparent}
    .footer{opacity:.65;font-size:12px;padding:24px 0}
    .toast{position:fixed;right:16px;bottom:16px;background:var(--panel);border:1px solid var(--muted);padding:10px 12px;border-radius:10px}
    .hint{font-size:12px;color:var(--sub)}
    .dragging{opacity:.6}
    .drop{outline:2px dashed var(--accent);outline-offset:-8px}
    @media (max-width: 980px){ .board{grid-template-columns:repeat(2, minmax(260px,1fr));} }
    @media (max-width: 600px){ .board{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div style="flex:1 1 auto">
        <h1>Tailor Board — Restich</h1>
        <div class="hint">Drag cards between columns to update <strong>Status</strong>. Data refreshes every 10 minutes (and on demand).</div>
      </div>
      <div class="row" role="group" aria-label="Controls">
        <input id="tailorId" placeholder="Filter by Tailor ID (local only)" />
        <button id="btnSaveFilter">Save</button>
        <button id="btnRefresh" class="primary">Refresh</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="board" id="board" aria-live="polite">
      <!-- Columns injected by JS -->
    </section>
    <div class="footer">Frontend is static (GitHub Pages). Data comes from a secure proxy to Airtable. No secrets in the browser. Auto-refresh: <span id="nextIn">–</span>.</div>
  </main>

  <div id="toast" class="toast" style="display:none"></div>

<script>
/**
 * === CONFIG ===
 * This page expects a tiny secure proxy (Vercel/Netlify/Cloudflare Worker)
 * so your Airtable token never hits the browser.
 *
 * Required proxy endpoints (adjust below if yours differs):
 *  GET   PROXY_BASE + "/list?table=Tailor%20Orders&filter=ENCODED_FORMULA"
 *  PATCH PROXY_BASE + "/update?id=recXXXX"  body: { fields: { Status: "Ready for pickup" } }
 */
const CONFIG = {
  PROXY_BASE: "https://restich.workers.dev",   // ← CHANGE THIS
  TABLE_NAME: "Tailor Orders",                    // Airtable table with tailor-facing data
  POLL_MS: 10 * 60 * 1000,                         // 10 minutes
  COLUMNS: [
    { key: "Queued", label: "Queued" },
    { key: "In Progress", label: "In Progress" },
    { key: "Ready for pickup", label: "Ready for pickup" },
    { key: "Picked up", label: "Picked up" },
  ],
  // Field names in Airtable (Tailor Order scope only)
  FIELDS: {
    id: "id",                      // Airtable record id (provided by API)
    tailorOrderId: "Tailor Order ID",
    clientOrderId: "Client Order ID",
    clientName: "Client name",
    garment: "Garment Type",
    details: "Repair Details",
    tailorId: "Tailor ID",
    priority: "Priority",         // e.g., Hot / High / Normal
    cost: "Tailor Cost",
    deadline: "Order Deadline",
    dropped: "Dropped off in store",
    status: "Status",
    ready: "Ready for pickup",
    picked: "Picked up",
  }
};

const $ = (q, el=document) => el.querySelector(q);
const $$ = (q, el=document) => [...el.querySelectorAll(q)];
const fmtDate = s => s ? new Date(s).toLocaleString() : "";
const money = n => n==null?"":`£${Number(n).toFixed(2)}`;

let DATA = [];         // last fetched records
let timer = null;      // polling interval
let nextTick = 0;      // next refresh timestamp

// --- UI: build columns ---
function buildBoard(){
  const board = $('#board');
  board.innerHTML = '';
  CONFIG.COLUMNS.forEach(col=>{
    const el = document.createElement('div');
    el.className = 'col'; el.dataset.status = col.key; el.innerHTML = `
      <h3>${col.label} <span class="count" data-count="${col.key}"></span></h3>
      <div class="lane" data-lane="${col.key}" aria-label="${col.label}" tabindex="0"></div>
    `;
    board.appendChild(el);
  });
}

// --- Fetch list (with optional Tailor ID filter) ---
async function listOrders(){
  const tailorId = localStorage.getItem('tailorId') || '';
  const filterFormula = tailorId ? `{${CONFIG.FIELDS.tailorId}}='${tailorId}'` : '';
  const url = new URL(CONFIG.PROXY_BASE + '/list');
  url.searchParams.set('table', CONFIG.TABLE_NAME);
  if (filterFormula) url.searchParams.set('filter', filterFormula);

  const r = await fetch(url.toString(), { cache: 'no-store' });
  if (!r.ok) throw new Error('List failed: '+r.status);
  const j = await r.json();
  // Expect shape: { records: [{ id, fields: { ... } }] }
  DATA = (j.records||[]).map(rec=> ({ id: rec.id, ...rec.fields }));
  renderCards();
}

function renderCards(){
  // clear lanes
  CONFIG.COLUMNS.forEach(c=>{ const lane = document.querySelector(`[data-lane="${c.key}"]`); if(lane) lane.innerHTML=''; });

  // group by status
  const by = (DATA||[]).reduce((acc,rec)=>{ const s = rec[CONFIG.FIELDS.status] || 'Queued'; (acc[s]=acc[s]||[]).push(rec); return acc; }, {});

  CONFIG.COLUMNS.forEach(c=>{
    const lane = document.querySelector(`[data-lane="${c.key}"]`);
    const rows = (by[c.key]||[]);
    $(`[data-count="${c.key}"]`).textContent = `(${rows.length})`;
    rows.sort((a,b)=> (a[CONFIG.FIELDS.priority]||'').localeCompare(b[CONFIG.FIELDS.priority]||''));
    rows.forEach(rec=> lane.appendChild(card(rec)) );
  });

  enableDnD();
}

function card(rec){
  const el = document.createElement('article');
  el.className = 'card'; el.setAttribute('draggable','true'); el.dataset.id = rec.id;
  const F = CONFIG.FIELDS; const pr = (rec[F.priority]||'').replace(/\s/g,'');
  el.innerHTML = `
    <div class="title"><strong>${rec[F.clientName]||'—'}</strong>
      ${rec[F.priority]?`<span class="tag prio-${pr}">${rec[F.priority]}</span>`:''}
    </div>
    <div class="meta">
      <span class="tag">${rec[F.garment]||''}</span>
      ${rec[F.tailorOrderId]?`<span class="tag">TO# ${rec[F.tailorOrderId]}</span>`:''}
      ${rec[F.clientOrderId]?`<span class="tag">CO# ${rec[F.clientOrderId]}</span>`:''}
      ${rec[F.cost]!=null?`<span class="tag">${money(rec[F.cost])}</span>`:''}
    </div>
    ${rec[F.details]?`<div class="small">${rec[F.details]}</div>`:''}
    ${rec[F.deadline]?`<div class="deadline">Deadline: ${fmtDate(rec[F.deadline])}</div>`:''}
  `;
  return el;
}

// --- Drag & Drop status updates ---
function enableDnD(){
  $$('.card').forEach(c=>{
    c.addEventListener('dragstart', e=>{ c.classList.add('dragging'); e.dataTransfer.setData('text/plain', c.dataset.id); });
    c.addEventListener('dragend', ()=> c.classList.remove('dragging') );
  });
  $$('.lane').forEach(l=>{
    l.addEventListener('dragover', e=>{ e.preventDefault(); l.classList.add('drop'); });
    l.addEventListener('dragleave', ()=> l.classList.remove('drop'));
    l.addEventListener('drop', async e=>{
      e.preventDefault(); l.classList.remove('drop');
      const id = e.dataTransfer.getData('text/plain');
      const newStatus = l.dataset.lane;
      await updateStatus(id, newStatus);
      await listOrders();
    });
  });
}

async function updateStatus(recordId, status){
  const url = new URL(CONFIG.PROXY_BASE + '/update');
  url.searchParams.set('id', recordId);
  const body = { fields: { [CONFIG.FIELDS.status]: status } };
  const r = await fetch(url.toString(), { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!r.ok){ toast('Update failed'); throw new Error('Update failed'); }
  toast('Status updated');
}

// --- Polling (10 minutes) ---
function startPolling(){
  clearInterval(timer);
  const run = async ()=>{ try{ await listOrders(); nextTick = Date.now()+CONFIG.POLL_MS; tickCountdown(); } catch(e){ console.error(e); toast('Refresh failed'); } };
  run();
  timer = setInterval(run, CONFIG.POLL_MS);
}

function tickCountdown(){
  function step(){
    const s = Math.max(0, Math.floor((nextTick-Date.now())/1000));
    const mm = String(Math.floor(s/60)).padStart(2,'0');
    const ss = String(s%60).padStart(2,'0');
    $('#nextIn').textContent = `${mm}:${ss}`;
    if (s>0) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

document.addEventListener('visibilitychange',()=>{
  if(document.visibilityState==='visible') startPolling(); else clearInterval(timer);
});

// --- UX helpers ---
function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display='none',2200) }

// --- Controls ---
$('#btnRefresh').addEventListener('click', ()=>{ nextTick = Date.now()+CONFIG.POLL_MS; listOrders(); tickCountdown(); });
$('#btnSaveFilter').addEventListener('click', ()=>{ localStorage.setItem('tailorId', $('#tailorId').value.trim()); startPolling(); });

// --- INIT ---
(function init(){
  buildBoard();
  $('#tailorId').value = localStorage.getItem('tailorId')||'';
  startPolling();
})();
</script>
</body>
</html>
