  <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Tailor Board — Restich</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#101720; --muted:#1f2a37; --soft:#0e141b; --text:#e8eef6; --sub:#b6c2d1; --accent:#7dd3fc;
    --touch:48px; /* min touch target */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#0a1118);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:rgba(10,15,20,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--muted)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 16px}
  h1{margin:0;font-size:22px}
  .hint{font-size:12px;color:var(--sub)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,button,select{border-radius:12px;border:1px solid var(--muted);background:var(--soft);color:var(--text);padding:12px 14px;font-size:16px;min-height:var(--touch)}
  button{cursor:pointer} button.primary{background:var(--accent);border:0;color:#06202b;font-weight:700}
  main{padding:18px 0}
  .board{display:grid;grid-template-columns:repeat(4,minmax(280px,1fr));gap:14px;align-items:start}
  .col{background:var(--panel);border:1px solid var(--muted);border-radius:16px;min-height:340px;display:flex;flex-direction:column;overflow:hidden}
  .col h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--muted);font-size:15px;letter-spacing:.3px}
  .count{opacity:.7;font-weight:400}
  .lane{padding:12px;display:grid;gap:12px;min-height:220px;overflow:auto;touch-action:pan-y}
  .card{background:#0c131b;border:1px solid var(--muted);border-radius:14px;padding:12px;display:grid;gap:8px}
  .title{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .tag{font-size:12px;border:1px solid var(--muted);border-radius:999px;padding:4px 10px;opacity:.95}
  .prio-Hot{background:#3b0b0b;color:#fecaca;border-color:#7f1d1d}
  .prio-High{background:#3b2906;color:#fde68a;border-color:#7c5f05}
  .prio-Normal{background:#0a2a1b;color:#bbf7d0;border-color:#14532d}
  .deadline{font-size:13px;opacity:.9}
  .meta{display:flex;flex-wrap:wrap;gap:8px;font-size:13px;opacity:.95}
  .small{font-size:14px;opacity:.95;line-height:1.35}
  .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .select{appearance:none}
  .toast{position:fixed;right:16px;bottom:16px;background:var(--panel);border:1px solid var(--muted);padding:12px 14px;border-radius:12px;display:none}
  .dragging{opacity:.6} .drop{outline:2px dashed var(--accent);outline-offset:-8px}
  @media (max-width: 1100px){ .board{grid-template-columns:repeat(3,minmax(280px,1fr));} }
  @media (max-width: 900px){ .board{grid-template-columns:repeat(2,minmax(260px,1fr));} h1{font-size:20px} }
  @media (max-width: 600px){ .board{grid-template-columns:1fr;} header .row input{flex:1} }
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div style="flex:1 1 auto">
      <h1>Tailor Board — Restich</h1>
      <div class="hint">Tablet-optimized. Drag between lanes (if supported) or use “Move”. Auto-refresh every 10 min.</div>
    </div>
    <div class="row" role="group">
      <input id="tailorId" placeholder="Filter by Tailor ID"/>
      <button id="btnSaveFilter">Save</button>
      <button id="btnRefresh" class="primary">Refresh</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="board" id="board"></section>
  <div style="opacity:.7;font-size:13px;padding:20px 2px">Next auto refresh in <span id="nextIn">—</span>.</div>
</main>

<div id="toast" class="toast"></div>

<script>
/* ====== CONFIG (update PROXY_BASE only) ====== */
const CONFIG = {
  PROXY_BASE: "https://restich-airtable-proxy.restich.workers.dev",
  TABLE_NAME: "Tailor Orders",
  POLL_MS: 10 * 60 * 1000,
  COLUMNS: [
    { key: "Queued", label: "Queued" },
    { key: "In Progress", label: "In Progress" },
    { key: "Ready for pickup", label: "Ready for pickup" },
    { key: "Picked up", label: "Picked up" },
  ],
  FIELDS: {
    id: "id",
    clientName: "Client Name",
    garment: "Garment Type",
    details: "Repair details",
    priority: "Priority",
    fee: "Tailor Fee",
    status: "Status",
    tailorStatus: "Tailor Status",
    dropped: "Drop-off in store",
    deadline: "Order Deadline",
    ready: "Ready for Pickup",
    picked: "Picked Up"
  }
};
/* ============================================= */

const $ = (q, el=document)=>el.querySelector(q);
const $$ = (q, el=document)=>[...el.querySelectorAll(q)];
const fmtDate = s => s ? new Date(s).toLocaleString() : "";
const money = v => (v==null || v==="") ? "" : `£${Number(v).toFixed(2)}`;
let DATA=[], timer=null, nextTick=0, supportsDnD = 'draggable' in document.createElement('div');

function buildBoard(){
  const board = $('#board'); board.innerHTML='';
  CONFIG.COLUMNS.forEach(col=>{
    const el = document.createElement('div');
    el.className='col'; el.dataset.status=col.key;
    el.innerHTML = `
      <h3>${col.label} <span class="count" data-count="${col.key}"></span></h3>
      <div class="lane" data-lane="${col.key}" aria-label="${col.label}" tabindex="0"></div>
    `;
    board.appendChild(el);
  });
}

async function listOrders(){
  const url = new URL(CONFIG.PROXY_BASE + '/list');
  url.searchParams.set('table', CONFIG.TABLE_NAME);
  const tid = (localStorage.getItem('tailorId')||'').trim();
  if(tid) url.searchParams.set('tailorId', tid);
  const r = await fetch(url.toString(), { cache:'no-store' });
  if(!r.ok) throw new Error('List failed '+r.status);
  const j = await r.json();
  DATA = (j.records||[]).map(rec => ({ id: rec.id, ...rec.fields }));
  renderCards();
}

function renderCards(){
  CONFIG.COLUMNS.forEach(c=>{ const lane=$(`[data-lane="${c.key}"]`); if(lane) lane.innerHTML=''; });
  const F=CONFIG.FIELDS;
  const by = (DATA||[]).reduce((acc,rec)=>{ const lane = rec[F.tailorStatus]||rec[F.status]||'Queued'; (acc[lane]=acc[lane]||[]).push(rec); return acc; }, {});
  CONFIG.COLUMNS.forEach(c=>{
    const lane = $(`[data-lane="${c.key}"]`); const rows=(by[c.key]||[]);
    $(`[data-count="${c.key}"]`).textContent = `(${rows.length})`;
    rows.forEach(rec => lane.appendChild(card(rec)));
  });
  enableInteractions();
}

function card(rec){
  const F=CONFIG.FIELDS;
  const el=document.createElement('article');
  el.className='card'; el.dataset.id=rec.id;
  if(supportsDnD) el.setAttribute('draggable','true');
  const pr = ((rec[F.priority]||'Normal').trim()).replace(/\s/g,'');
  const flags = [
    rec[F.dropped] ? 'Dropped-off' : '',
    rec[F.ready] ? 'Ready' : '',
    rec[F.picked] ? 'Picked' : ''
  ].filter(Boolean).map(t=>`<span class="tag">${t}</span>`).join('');
  const moveSelect = `
    <label class="hint" style="display:block;font-size:12px;margin-top:4px;margin-bottom:2px">Move</label>
    <select class="select" data-move>
      ${CONFIG.COLUMNS.map(c=>`<option value="${c.key}">${c.label}</option>`).join('')}
    </select>
  `;
  el.innerHTML = `
    <div class="title">
      <strong style="font-size:16px">${rec[F.clientName]||'—'}</strong>
      ${rec[F.priority]?`<span class="tag prio-${pr}">${rec[F.priority]}</span>`:''}
    </div>
    <div class="meta">
      ${rec[F.garment]?`<span class="tag">${rec[F.garment]}</span>`:''}
      ${rec[F.fee]!=null && rec[F.fee]!==''?`<span class="tag">${money(rec[F.fee])}</span>`:''}
      ${flags}
    </div>
    ${rec[F.details]?`<div class="small">${rec[F.details]}</div>`:''}
    ${rec[F.deadline]?`<div class="deadline">Deadline: ${fmtDate(rec[F.deadline])}</div>`:''}
    <div class="actions">
      ${moveSelect}
    </div>
  `;
  // preselect current lane in the Move picker
  const current = rec[F.tailorStatus]||rec[F.status]||'Queued';
  el.querySelector('[data-move]').value = current;
  // Move action handler
  el.querySelector('[data-move]').addEventListener('change', async (e)=>{
    await updateStatus(rec.id, e.target.value);
    await listOrders();
  });
  return el;
}

/* Drag & Drop (for browsers that support it) */
function enableInteractions(){
  if(supportsDnD){
    $$('.card').forEach(c=>{
      c.addEventListener('dragstart', e=>{ c.classList.add('dragging'); e.dataTransfer.setData('text/plain', c.dataset.id); });
      c.addEventListener('dragend', ()=> c.classList.remove('dragging'));
    });
    $$('.lane').forEach(l=>{
      l.addEventListener('dragover', e=>{ e.preventDefault(); l.classList.add('drop'); });
      l.addEventListener('dragleave', ()=> l.classList.remove('drop'));
      l.addEventListener('drop', async e=>{
        e.preventDefault(); l.classList.remove('drop');
        const id = e.dataTransfer.getData('text/plain');
        await updateStatus(id, l.dataset.lane);
        await listOrders();
      });
    });
  }
}

async function updateStatus(recordId, lane){
  const url = new URL(CONFIG.PROXY_BASE + '/update');
  url.searchParams.set('id', recordId);
  const F=CONFIG.FIELDS;
  const body = { fields: { [F.tailorStatus]: lane } };
  const r = await fetch(url.toString(), { method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if(!r.ok){ toast('Update failed'); throw new Error('update failed'); }
  toast('Status updated');
}

/* Polling & controls */
function startPolling(){
  clearInterval(timer);
  const run = async ()=>{ try{ await listOrders(); nextTick=Date.now()+CONFIG.POLL_MS; tickCountdown(); } catch(e){ console.error(e); toast('Refresh failed'); } };
  run(); timer=setInterval(run, CONFIG.POLL_MS);
}
function tickCountdown(){
  function step(){ const s=Math.max(0,Math.floor((nextTick-Date.now())/1000)); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); $('#nextIn').textContent=`${mm}:${ss}`; if(s>0) requestAnimationFrame(step); }
  requestAnimationFrame(step);
}
document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') startPolling(); else clearInterval(timer); });

function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._h); t._h=setTimeout(()=>t.style.display='none',2200); }

$('#btnRefresh').addEventListener('click', ()=>{ nextTick=Date.now()+CONFIG.POLL_MS; listOrders(); tickCountdown(); });
$('#btnSaveFilter').addEventListener('click', ()=>{ localStorage.setItem('tailorId',$('#tailorId').value.trim()); startPolling(); });

/* init */
(function(){ buildBoard(); $('#tailorId').value = localStorage.getItem('tailorId')||''; startPolling(); })();
</script>
</body>
</html>
